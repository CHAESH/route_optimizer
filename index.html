<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경로 최적화 도구</title>
    <script src="config.js"></script>
    <!-- Kakao 지도 API 로드 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=" + window.KAKAO_API_KEY + "&libraries=services"></script>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-size: 16px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        
        .left-panel {
            padding: 0;
        }
        
        .right-panel {
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
        }
        
        #map {
            width: 100%;
            height: 600px;
            border-radius: 0;
        }
        
        .map-container {
            position: relative;
            height: 600px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
        }
        
        .map-loading {
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                border-left: none;
                border-top: 1px solid #e9ecef;
            }
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .step {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }
        
        .step:last-child {
            border-bottom: none;
        }
        
        .step-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .input-field {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: #f0fff0;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #95a5a6;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            font-size: 14px;
            color: #95a5a6;
        }
        
        .file-input {
            display: none;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calculate-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }
        
        .calculate-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .summary {
            background: #27ae60;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .summary h3 {
            margin: 0 0 10px 0;
            font-size: 22px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .route-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .route-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .route-item:last-child {
            border-bottom: none;
        }
        
        .route-item.start {
            background: #d5f4e6;
        }
        
        .route-item.completed {
            background: #f0f0f0;
            opacity: 0.7;
        }
        
        .route-item.completed .route-number {
            background: #95a5a6;
        }
        
        .route-item.completed .route-name {
            text-decoration: line-through;
            color: #7f8c8d;
        }
        
        .visit-checkbox {
            margin-left: auto;
            transform: scale(1.5);
            cursor: pointer;
        }
        
        .visit-status {
            margin-left: auto;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .visit-status.completed {
            background: #27ae60;
            color: white;
        }
        
        .visit-status.pending {
            background: #3498db;
            color: white;
        }
        
        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #27ae60;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
            margin-top: 5px;
        }
        
        .reset-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .reset-btn:hover {
            background: #c0392b;
        }
        
        .route-number {
            background: #3498db;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 20px;
            font-size: 16px;
        }
        
        .route-number.start {
            background: #27ae60;
        }
        
        .route-info {
            flex: 1;
        }
        
        .route-name {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .route-address {
            color: #7f8c8d;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .route-contact {
            color: #e74c3c;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .route-timing {
            font-size: 14px;
            color: #27ae60;
            font-weight: bold;
        }
        
        .download-section {
            margin-top: 25px;
            text-align: center;
        }
        
        .download-btn {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }
        
        .download-btn:hover {
            background: #2980b9;
            color: white;
            text-decoration: none;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            font-size: 14px;
            color: #27ae60;
            display: none;
        }
        
        .highlight-box {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
        }

        .info-window-content {
            max-width: 300px;
            font-family: 'Malgun Gothic', sans-serif;
        }
        
        .info-window-title {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: bold;
        }
        
        .info-window-contact {
            margin: 0 0 5px 0;
            color: #e74c3c;
            font-weight: bold;
            font-size: 14px;
        }
        
        .info-window-address {
            margin: 0 0 8px 0;
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .info-window-status {
            margin: 5px 0 0 0;
            font-weight: bold;
            font-size: 14px;
        }
        
        .info-window-status.completed {
            color: #27ae60;
        }
        
        .info-window-status.pending {
            color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 방문 순서 최적화</h1>
            <p>현재 위치 + CSV 파일 = 지역별 최적 경로 자동 계산</p>
        </div>
        
        <div class="main-content">
            <!-- 왼쪽 패널: 입력 및 결과 -->
            <div class="left-panel">
                <!-- 1단계: 현재 위치 -->
                <div class="step">
                    <div class="step-title">📍 1. 현재 위치 입력</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="currentLocation" class="input-field" 
                               placeholder="예: 서울시 강남구 테헤란로 123" 
                               value="서울시 강남구 테헤란로 123"
                               style="flex: 1; margin-bottom: 0;">
                        <button id="getCurrentLocationBtn" class="calculate-btn" 
                                style="width: auto; padding: 10px 15px; font-size: 14px; margin: 0;">
                            📍 현재위치
                        </button>
                    </div>
                    <div id="locationStatus" style="font-size: 12px; color: #7f8c8d; margin-top: 5px; display: none;"></div>
                </div>
                
                <!-- 2단계: 파일 업로드 -->
                <div class="step">
                    <div class="step-title">📁 2. CSV 파일 업로드</div>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📂</div>
                        <div class="upload-text">CSV 파일을 여기에 끌어다 놓거나 클릭하세요</div>
                        <div class="upload-subtext">.csv 파일만 지원</div>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".csv">
                    <div id="fileInfo" class="file-info"></div>
                    
                    <div class="highlight-box">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">📝 파일 준비 방법</div>
                        <div style="color: #856404; font-size: 14px;">
                            <strong>엑셀(.xlsx) 파일인 경우:</strong><br>
                            1. 엑셀에서 "파일" → "다른 이름으로 저장"<br>
                            2. "파일 형식"에서 <strong>"CSV(쉼표로 분리)(*.csv)"</strong> 선택<br>
                            3. 저장 후 CSV 파일을 업로드<br><br>
                            <strong>권장 컬럼 순서:</strong> 이름, 연락처, 주소
                        </div>
                    </div>
                </div>
                
                <!-- 3단계: 지역 선택 -->
                <div class="step" id="regionStep" style="display: none;">
                    <div class="step-title">🎯 3. 오늘 방문할 지역 선택</div>
                    <select id="regionSelect" class="input-field">
                        <option value="">지역을 선택하세요</option>
                    </select>
                    <div id="regionInfo" style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 14px; display: none;"></div>
                </div>
                
                <!-- 4단계: 계산 -->
                <div class="step">
                    <div class="step-title">🚀 4. 최적 경로 계산</div>
                    <button id="calculateBtn" class="calculate-btn" disabled>
                        📊 선택한 지역 최적 순서 계산하기
                    </button>
                </div>
                
                <!-- 로딩 -->
                <div id="loading" class="loading">
                    <div class="loading-spinner"></div>
                    <div>최적 경로를 계산하고 있습니다...<br>잠시만 기다려주세요.</div>
                </div>
                
                <!-- 오류 메시지 -->
                <div id="error" class="error"></div>
                
                <!-- 결과 -->
                <div id="results" class="results">
                    <div id="summary" class="summary">
                        <h3>🎉 최적 경로 계산 완료!</h3>
                        <div class="summary-stats">
                            <div class="stat">
                                <span id="totalDistance" class="stat-number">0km</span>
                                <span class="stat-label">총 거리</span>
                            </div>
                            <div class="stat">
                                <span id="totalTime" class="stat-number">0분</span>
                                <span class="stat-label">총 시간</span>
                            </div>
                            <div class="stat">
                                <span id="totalPlaces" class="stat-number">0곳</span>
                                <span class="stat-label">방문지</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="routeList" class="route-list"></div>
                    
                    <div class="download-section">
                        <button class="download-btn" onclick="downloadResults()">📊 엑셀로 저장</button>
                        <button class="download-btn" onclick="printResults()">🖨️ 인쇄하기</button>
                    </div>
                </div>
            </div>
            
            <!-- 오른쪽 패널: 지도 -->
            <div class="right-panel">
                <div id="mapContainer" class="map-container">
                    <div class="map-loading">
                        <div>🗺️</div>
                        <div>지역을 선택하고 계산하면<br>여기에 지도가 표시됩니다</div>
                    </div>
                    <div id="map" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== 전역 변수 =====
        let map = null;
        let geocoder = null;
        let markers = [];
        let polylines = [];
        let visitedAddresses = new Set();
        let allAddresses = [];
        let selectedAddresses = [];
        let regionGroups = {};
        let optimizedRoute = null;
        let currentLocation = '';
        let currentLocationMarker = null;

        // 페이지 로드 완료 후 초기화
        window.addEventListener('load', function() {
            console.log('페이지 로드 완료');
            waitForKakaoMaps();
        });

        // Kakao Maps SDK 로드 완료 대기
        function waitForKakaoMaps() {
            if (typeof kakao === 'undefined' || !kakao.maps) {
                console.log('Kakao Maps SDK 로딩 중...');
                setTimeout(waitForKakaoMaps, 100);
                return;
            }
            
            console.log('✅ Kakao Maps SDK 로드 완료');
            initializeApp();
        }

        // 앱 초기화
        function initializeApp() {
            console.log('앱 초기화 시작');
            
            try {
                // 카카오맵 API 초기화
                geocoder = new kakao.maps.services.Geocoder();
                console.log('✅ Kakao Maps Geocoder 초기화 완료');
                
                // 방문 기록 로드
                loadVisitedAddresses();
                
                // 이벤트 리스너 등록
                setupEventListeners();
                
                console.log('앱 초기화 완료');
            } catch (error) {
                console.error('❌ 앱 초기화 실패:', error);
                showError('앱 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const regionSelect = document.getElementById('regionSelect');
            const calculateBtn = document.getElementById('calculateBtn');
            const getCurrentLocationBtn = document.getElementById('getCurrentLocationBtn');

            if (!uploadArea || !fileInput || !regionSelect || !calculateBtn || !getCurrentLocationBtn) {
                console.error('필수 요소를 찾을 수 없습니다');
                showError('페이지 로딩 오류가 발생했습니다.');
                return;
            }

            uploadArea.onclick = () => fileInput.click();
            getCurrentLocationBtn.onclick = getCurrentLocation;
            
            // 파일 업로드 관련 이벤트
            setupFileUploadEvents(uploadArea, fileInput);

            // 지역 선택 이벤트
            regionSelect.onchange = handleRegionChange;

            // 계산 버튼 이벤트
            calculateBtn.onclick = startCalculation;
        }

        // 현재 위치 가져오기
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const locPosition = new kakao.maps.LatLng(lat, lng);
                        
                        // 기존 현재 위치 마커 제거
                        if (currentLocationMarker) {
                            currentLocationMarker.setMap(null);
                        }
                        
                        // 새 마커 생성
                        currentLocationMarker = new kakao.maps.Marker({
                            map: map,
                            position: locPosition
                        });
                        
                        // 지도 중심 이동
                        map.setCenter(locPosition);
                        map.setLevel(4);
                        
                        // 상태 메시지 표시
                        showStatus('locationStatus', '현재 위치를 찾았습니다.', 'success');
                    },
                    function(error) {
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '위치 정보 접근이 거부되었습니다.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '위치 정보를 사용할 수 없습니다.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '위치 정보 요청이 시간 초과되었습니다.';
                                break;
                            default:
                                errorMessage = '알 수 없는 오류가 발생했습니다.';
                        }
                        showStatus('locationStatus', errorMessage, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );
            } else {
                showStatus('locationStatus', '이 브라우저에서는 위치 정보를 사용할 수 없습니다.', 'error');
            }
        }

        // 지도에 경로 표시
        function displayRouteOnMap() {
            console.log('지도에 경로 표시 시작');
            
            if (!optimizedRoute || !optimizedRoute.route) {
                console.error('표시할 경로 데이터가 없습니다.');
                return;
            }
            
            // 지도 컨테이너 표시
            document.getElementById('mapContainer').querySelector('.map-loading').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            
            // 지도 초기화 (한 번만)
            if (!map) {
                console.log('지도 초기화 중...');
                const container = document.getElementById('map');
                const options = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780),
                    level: 7
                };
                map = new kakao.maps.Map(container, options);
                console.log('지도 초기화 완료');
            }
            
            // 기존 마커와 경로 삭제
            clearMapElements();
            
            // 좌표 변환 및 마커 표시
            convertAddressesToCoordinates();
        }

        // 주소를 좌표로 변환하고 마커 표시
        function convertAddressesToCoordinates() {
            const addresses = [
                { address: currentLocation, type: 'start', title: '출발지' },
                ...optimizedRoute.route.map(item => ({
                    address: item.address,
                    type: 'destination',
                    title: `${item.order}. ${item.name}`,
                    data: item
                }))
            ];
            
            let completedCount = 0;
            const coordinates = [];
            
            addresses.forEach((item, index) => {
                geocoder.addressSearch(item.address, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        coordinates[index] = {
                            position: coords,
                            type: item.type,
                            title: item.title,
                            data: item.data
                        };
                        
                        completedCount++;
                        
                        if (completedCount === addresses.length) {
                            createMarkersAndRoute(coordinates);
                        }
                    } else {
                        console.error(`주소 변환 실패: ${item.address}`);
                        completedCount++;
                    }
                });
            });
        }

        // 마커와 경로선 생성
        function createMarkersAndRoute(coordinates) {
            coordinates.forEach((coord, index) => {
                // 마커 생성
                const marker = new kakao.maps.Marker({
                    position: coord.position,
                    map: map
                });
                
                // 인포윈도우 생성
                const infoContent = createInfoWindowContent(coord);
                const infowindow = new kakao.maps.InfoWindow({
                    content: infoContent
                });
                
                // 마커 클릭 이벤트
                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, marker);
                });
                
                markers.push(marker);
                
                // 경로선 그리기 (마지막 지점 제외)
                if (index < coordinates.length - 1) {
                    const linePath = [
                        coord.position,
                        coordinates[index + 1].position
                    ];
                    
                    const polyline = new kakao.maps.Polyline({
                        path: linePath,
                        strokeWeight: 3,
                        strokeColor: '#e74c3c',
                        strokeOpacity: 0.7,
                        strokeStyle: 'solid'
                    });
                    
                    polyline.setMap(map);
                    polylines.push(polyline);
                }
            });
            
            // 지도 범위 조정
            const bounds = new kakao.maps.LatLngBounds();
            coordinates.forEach(coord => bounds.extend(coord.position));
            map.setBounds(bounds);
        }

        // 주소 키 생성 (고유 식별자)
        function getAddressKey(addressObj) {
            return `${addressObj.name}_${addressObj.address}`.replace(/\s+/g, '');
        }

        // 방문 완료 토글 (개선된 버전)
        function toggleVisitStatus(addressObj) {
            const key = getAddressKey(addressObj);
            
            if (visitedAddresses.has(key)) {
                visitedAddresses.delete(key);
                console.log(`✅ 방문 완료 해제: ${addressObj.name}`);
            } else {
                visitedAddresses.add(key);
                console.log(`🎯 방문 완료 설정: ${addressObj.name}`);
            }
            
            saveVisitedAddresses();
            
            // UI 즉시 업데이트
            updateRouteDisplay();
            updateMapDisplay();
            
            // 지역 선택 드롭다운도 즉시 업데이트
            updateRegionDropdown();
            
            // 현재 선택된 지역 정보도 업데이트
            const regionSelect = document.getElementById('regionSelect');
            if (regionSelect.value) {
                updateRegionInfo(regionSelect.value);
            }
        }

        // 지역 드롭다운 업데이트 (방문 기록 반영)
        function updateRegionDropdown() {
            if (Object.keys(regionGroups).length === 0) return;
            
            const regionSelect = document.getElementById('regionSelect');
            const currentValue = regionSelect.value;
            
            // 드롭다운 다시 생성
            regionSelect.innerHTML = '<option value="">오늘 방문할 지역을 선택하세요</option>';

            Object.keys(regionGroups).sort().forEach(region => {
                const totalCount = regionGroups[region].length;
                const visitedCount = regionGroups[region].filter(addr => 
                    visitedAddresses.has(getAddressKey(addr))
                ).length;
                const remainingCount = totalCount - visitedCount;
                
                const option = document.createElement('option');
                option.value = region;
                option.textContent = `${region} (전체: ${totalCount}곳, 남은곳: ${remainingCount}곳)`;
                
                // 모두 방문 완료된 지역은 스타일 변경
                if (remainingCount === 0) {
                    option.disabled = true;
                    option.textContent += ' ✅완료';
                    option.style.color = '#27ae60';
                    option.style.fontWeight = 'bold';
                }
                
                regionSelect.appendChild(option);
            });
            
            // 이전 선택값 복원
            if (currentValue) {
                regionSelect.value = currentValue;
            }
            
            console.log('🔄 지역 드롭다운 업데이트 완료');
        }

        // 지역 정보 업데이트
        function updateRegionInfo(selectedRegion) {
            if (!regionGroups[selectedRegion]) return;
            
            const unvisitedAddresses = regionGroups[selectedRegion].filter(addr => 
                !visitedAddresses.has(getAddressKey(addr))
            );
            
            selectedAddresses = unvisitedAddresses;
            
            const calculateBtn = document.getElementById('calculateBtn');
            calculateBtn.disabled = selectedAddresses.length === 0;
            
            const regionInfo = document.getElementById('regionInfo');
            const totalCount = regionGroups[selectedRegion].length;
            const visitedCount = totalCount - unvisitedAddresses.length;
            
            regionInfo.innerHTML = `
                ✅ ${selectedRegion} 선택됨<br>
                📍 총 ${totalCount}개 중 ${visitedCount}개 방문완료<br>
                🎯 오늘 방문할 곳: ${unvisitedAddresses.length}개
            `;
            regionInfo.style.display = 'block';
            
            if (unvisitedAddresses.length === 0) {
                regionInfo.innerHTML += '<br>🎉 이 지역은 모두 방문 완료했습니다!';
                regionInfo.style.background = '#d4edda';
                regionInfo.style.color = '#155724';
            } else {
                regionInfo.style.background = '#e8f5e8';
                regionInfo.style.color = '#27ae60';
            }
            
            console.log(`📊 ${selectedRegion}: ${visitedCount}/${totalCount} 완료, 남은 곳: ${unvisitedAddresses.length}개`);
        }

        // 모든 방문 기록 초기화
        function resetAllVisited() {
            if (confirm('모든 방문 기록을 초기화하시겠습니까?')) {
                visitedAddresses.clear();
                saveVisitedAddresses();
                updateRouteDisplay();
                updateMapDisplay();
                
                // 지역 정보도 업데이트
                const regionSelect = document.getElementById('regionSelect');
                if (regionSelect.value) {
                    regionSelect.onchange();
                }
                
                console.log('모든 방문 기록 초기화 완료');
            }
        }

        // 파일 처리
        function handleFile(file) {
            console.log('파일 처리 시작:', file.name);
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('CSV 파일만 업로드 가능합니다.');
                return;
            }

            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `✅ 파일 로드됨: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
            fileInfo.style.display = 'block';

            const reader = new FileReader();
            reader.onload = (e) => {
                parseCSV(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }

        // 개선된 CSV 파싱 (연락처 정보 포함)
        function parseCSV(text) {
            console.log('CSV 파싱 시작');
            allAddresses = [];
            const lines = text.split('\n');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // 쉼표와 탭 모두 구분자로 처리
                const columns = line.split(/[,\t]/).map(col => col.replace(/"/g, '').trim());
                
                let name = null;
                let contact = null;
                let address = null;

                // 각 컬럼 분석
                for (let j = 0; j < columns.length; j++) {
                    const col = columns[j];
                    if (!col || col.length < 2) continue;

                    // 주소 패턴 검색 (가장 확실한 기준)
                    if (!address && isAddressPattern(col)) {
                        address = col;
                        
                        // 주소 발견 시 앞쪽 컬럼들에서 이름과 연락처 찾기
                        for (let k = Math.max(0, j-3); k < j; k++) {
                            const prevCol = columns[k];
                            if (!prevCol) continue;
                            
                            // 연락처 패턴 (숫자만 8자리 이상 또는 전화번호 형태)
                            if (!contact && isContactPattern(prevCol)) {
                                contact = prevCol;
                            }
                            
                            // 이름 패턴 (한글 2-4글자 또는 상호명)
                            if (!name && isNamePattern(prevCol)) {
                                name = prevCol;
                            }
                        }
                        break;
                    }
                }

                // 주소가 있으면 추가 (헤더 제외)
                if (address && !isHeaderRow(address)) {
                    allAddresses.push({ 
                        name: name || `방문지${allAddresses.length + 1}`,
                        address: address,
                        contact: contact || ''
                    });
                }
            }

            console.log(`파싱 완료: ${allAddresses.length}개 주소`);

            if (allAddresses.length > 0) {
                groupByRegion();
                document.getElementById('fileInfo').innerHTML += `<br>📍 총 ${allAddresses.length}개 주소 발견`;
                document.getElementById('regionStep').style.display = 'block';
            } else {
                showError('주소 데이터를 찾을 수 없습니다. CSV 파일의 주소 컬럼을 확인해주세요.');
            }
        }

        // 주소 패턴 검사
        function isAddressPattern(text) {
            if (text.length < 5) return false;
            
            // 시/도 + 구/군 + 동/로/길 패턴
            const addressPatterns = [
                /.*[시도].*[구군].*[동로길]/,
                /.*[시도].*[구군]/,
                /.*[구군].*[동로길]/,
                /.*[시도].*[동로길]/
            ];
            
            return addressPatterns.some(pattern => pattern.test(text));
        }

        // 연락처 패턴 검사
        function isContactPattern(text) {
            // 숫자만 8자리 이상
            if (/^\d{8,}$/.test(text)) return true;
            
            // 전화번호 형태 (하이픈 포함)
            if (/^\d{2,4}-\d{3,4}-\d{4}$/.test(text)) return true;
            
            // 휴대폰 번호 형태
            if (/^01[0-9]-\d{3,4}-\d{4}$/.test(text)) return true;
            
            return false;
        }

        // 이름 패턴 검사
        function isNamePattern(text) {
            if (text.length < 2 || text.length > 20) return false;
            
            // 한글 이름 (2-4글자)
            if (/^[가-힣]{2,4}$/.test(text)) return true;
            
            // 상호명 (한글 포함, 특수문자 제외)
            if (/^[가-힣a-zA-Z0-9\s]{2,15}$/.test(text) && /[가-힣]/.test(text)) return true;
            
            return false;
        }

        // 헤더 행 검사
        function isHeaderRow(text) {
            const headerKeywords = ['주소', '이름', '연락처', '전화', '상호', 'address', 'name', 'phone'];
            return headerKeywords.some(keyword => text.includes(keyword));
        }

        // 지역별 그룹핑 (개선된 버전)
        function groupByRegion() {
            regionGroups = {};

            allAddresses.forEach(item => {
                const region = getRegion(item.address);
                if (!regionGroups[region]) {
                    regionGroups[region] = [];
                }
                regionGroups[region].push(item);
            });

            // 드롭다운 업데이트 (방문 기록 반영)
            updateRegionDropdown();

            console.log('🗂️ 지역 그룹핑 완료:', Object.keys(regionGroups));
            
            // 총 방문 기록 통계
            const totalAddresses = allAddresses.length;
            const totalVisited = allAddresses.filter(addr => visitedAddresses.has(getAddressKey(addr))).length;
            console.log(`📊 전체 통계: ${totalVisited}/${totalAddresses} 방문완료 (${((totalVisited/totalAddresses)*100).toFixed(1)}%)`);
        }

        // 지역 분류
        function getRegion(address) {
            if (address.includes('서울')) {
                if (address.includes('강남') || address.includes('서초') || address.includes('송파') || address.includes('강동')) return '서울 강남권';
                if (address.includes('강서') || address.includes('양천') || address.includes('구로') || address.includes('금천')) return '서울 서부';
                if (address.includes('강북') || address.includes('성북') || address.includes('도봉') || address.includes('노원')) return '서울 북부';
                if (address.includes('종로') || address.includes('중구') || address.includes('용산')) return '서울 중심가';
                if (address.includes('마포') || address.includes('서대문') || address.includes('은평')) return '서울 서북부';
                if (address.includes('동대문') || address.includes('성동') || address.includes('광진') || address.includes('중랑')) return '서울 동부';
                return '서울 기타';
            }
            if (address.includes('경기')) {
                if (address.includes('수원') || address.includes('화성') || address.includes('용인') || address.includes('오산')) return '경기 남부';
                if (address.includes('고양') || address.includes('파주') || address.includes('의정부') || address.includes('양주')) return '경기 북부';
                if (address.includes('부천') || address.includes('시흥') || address.includes('안산') || address.includes('광명')) return '경기 서부';
                if (address.includes('성남') || address.includes('하남') || address.includes('구리') || address.includes('남양주')) return '경기 동부';
                if (address.includes('안양') || address.includes('과천') || address.includes('의왕') || address.includes('군포')) return '경기 중부';
                return '경기 기타';
            }
            if (address.includes('인천')) return '인천';
            if (address.includes('대전')) return '대전';
            if (address.includes('광주')) return '광주';
            if (address.includes('대구')) return '대구';
            if (address.includes('울산')) return '울산';
            if (address.includes('부산')) return '부산';
            if (address.includes('충북') || address.includes('청주') || address.includes('충주')) return '충북';
            if (address.includes('충남') || address.includes('천안') || address.includes('아산')) return '충남';
            if (address.includes('전북') || address.includes('전주') || address.includes('익산')) return '전북';
            if (address.includes('전남') || address.includes('목포') || address.includes('순천')) return '전남';
            if (address.includes('경북') || address.includes('구미') || address.includes('포항')) return '경북';
            if (address.includes('경남') || address.includes('창원') || address.includes('김해')) return '경남';
            if (address.includes('제주')) return '제주';
            return '기타';
        }

        // 계산 시작 (개선된 버전)
        async function startCalculation() {
            console.log('=== 최적 경로 계산 시작 ===');
            
            currentLocation = document.getElementById('currentLocation').value.trim();
            
            if (!currentLocation) {
                showError('현재 위치를 입력해주세요.');
                return;
            }
            
            if (!selectedAddresses || selectedAddresses.length === 0) {
                showError('방문할 지역을 선택해주세요.');
                return;
            }

            // 네트워크 및 API 상태 확인
            if (!checkNetworkAndAPI()) {
                return;
            }

            showLoading();

            try {
                console.log(`출발지: ${currentLocation}`);
                console.log(`방문지 ${selectedAddresses.length}개:`, selectedAddresses.map(addr => addr.name));

                // 개선된 최적 경로 계산
                const optimizedResult = await calculateOptimalRoute(currentLocation, selectedAddresses);
                console.log('✅ 최적 경로 계산 완료');

                optimizedRoute = optimizedResult;
                displayResults();

            } catch (error) {
                console.error('❌ 계산 오류:', error);
                
                let errorMessage = '계산 중 오류가 발생했습니다.';
                if (error.message.includes('OVER_QUERY_LIMIT')) {
                    errorMessage = 'Google Maps API 일일 사용량을 초과했습니다. 내일 다시 시도해주세요.';
                } else if (error.message.includes('REQUEST_DENIED')) {
                    errorMessage = 'API 키 권한이 없습니다. 관리자에게 문의하세요.';
                } else if (error.message.includes('INVALID_REQUEST')) {
                    errorMessage = '주소 형식이 올바르지 않습니다. 주소를 다시 확인해주세요.';
                } else if (error.message.includes('ZERO_RESULTS')) {
                    errorMessage = '경로를 찾을 수 없습니다. 주소를 다시 확인해주세요.';
                } else {
                    errorMessage += ` (${error.message})`;
                }
                
                showError(errorMessage);
            } finally {
                hideLoading();
            }
        }

        // 개선된 최적 경로 계산 (실제 도로 기준)
        async function calculateOptimalRoute(origin, destinations) {
            console.log('🚗 실제 도로 기준 최적 경로 계산 시작');
            
            // 1단계: 모든 지점 간 거리/시간 매트릭스 생성
            const allPoints = [{ name: '출발지', address: origin, contact: '' }, ...destinations];
            const distanceMatrix = await buildDistanceMatrix(allPoints);
            
            // 2단계: 그리디 알고리즘으로 최적 순서 계산
            const optimalOrder = findOptimalRoute(distanceMatrix, allPoints);
            
            // 3단계: 최종 경로 정보 생성
            const finalRoute = await buildFinalRoute(optimalOrder, distanceMatrix);
            
            return finalRoute;
        }

        // 모든 지점 간 거리/시간 매트릭스 생성
        async function buildDistanceMatrix(points) {
            console.log(`📊 ${points.length}x${points.length} 거리 매트릭스 생성 중...`);
            
            const matrix = [];
            for (let i = 0; i < points.length; i++) {
                matrix[i] = [];
                for (let j = 0; j < points.length; j++) {
                    if (i === j) {
                        matrix[i][j] = {
                            distance: 0,
                            duration: 0,
                            distanceText: '0km',
                            durationText: '0분'
                        };
                        continue;
                    }
                    
                    try {
                        // 두 지점 간의 거리를 계산
                        const result = await calculateDistance(points[i].address, points[j].address);
                        matrix[i][j] = result;
                    } catch (error) {
                        console.warn(`거리 계산 실패 (${points[i].name} → ${points[j].name}):`, error);
                        // 실패 시 기본값 사용
                        matrix[i][j] = {
                            distance: 10000, // 10km
                            duration: 1200,  // 20분
                            distanceText: '약 10km',
                            durationText: '약 20분'
                        };
                    }
                }
            }
            
            console.log('✅ 거리 매트릭스 생성 완료');
            return matrix;
        }

        // 두 지점 간 거리 계산 (Kakao Maps API 사용)
        function calculateDistance(origin, destination) {
            return new Promise((resolve, reject) => {
                geocoder.addressSearch(origin, (result1, status1) => {
                    if (status1 === kakao.maps.services.Status.OK) {
                        const originCoord = new kakao.maps.LatLng(result1[0].y, result1[0].x);
                        
                        geocoder.addressSearch(destination, (result2, status2) => {
                            if (status2 === kakao.maps.services.Status.OK) {
                                const destCoord = new kakao.maps.LatLng(result2[0].y, result2[0].x);
                                
                                // 직선 거리 계산
                                const distance = Math.round(
                                    kakao.maps.geometry.getDistance(originCoord, destCoord)
                                );
                                
                                // 예상 소요 시간 계산 (평균 속도 40km/h 가정)
                                const duration = Math.round((distance / 40000) * 3600);
                                
                                resolve({
                                    distance: distance,
                                    duration: duration,
                                    distanceText: `${(distance/1000).toFixed(1)}km`,
                                    durationText: `${Math.round(duration/60)}분`
                                });
                            } else {
                                reject(new Error('목적지 주소 검색 실패'));
                            }
                        });
                    } else {
                        reject(new Error('출발지 주소 검색 실패'));
                    }
                });
            });
        }

        // 그리디 알고리즘으로 최적 경로 찾기
        function findOptimalRoute(matrix, points) {
            console.log('🎯 그리디 알고리즘으로 최적 순서 계산 중...');
            
            const route = [0]; // 출발지부터 시작
            const visited = new Set([0]);
            let currentPoint = 0;
            
            // 출발지 제외한 모든 지점 방문
            while (visited.size < points.length) {
                let nearestPoint = -1;
                let nearestDistance = Infinity;
                
                // 현재 지점에서 가장 가까운 미방문 지점 찾기
                for (let i = 1; i < points.length; i++) { // 출발지(0) 제외
                    if (!visited.has(i) && matrix[currentPoint][i].distance < nearestDistance) {
                        nearestDistance = matrix[currentPoint][i].distance;
                        nearestPoint = i;
                    }
                }
                
                if (nearestPoint !== -1) {
                    route.push(nearestPoint);
                    visited.add(nearestPoint);
                    currentPoint = nearestPoint;
                    
                    console.log(`${visited.size - 1}번째: ${points[nearestPoint].name} (거리: ${matrix[route[route.length - 2]][nearestPoint].distanceText})`);
                }
            }
            
            console.log('✅ 최적 순서 계산 완료:', route.map(i => points[i].name));
            return route;
        }

        // 최종 경로 정보 생성
        async function buildFinalRoute(routeOrder, matrix) {
            console.log('📋 최종 경로 정보 생성 중...');
            
            const route = [];
            let cumulativeDistance = 0;
            let cumulativeTime = 0;
            
            // 출발지 제외하고 방문지들만 처리
            for (let i = 1; i < routeOrder.length; i++) {
                const currentIndex = routeOrder[i];
                const prevIndex = routeOrder[i - 1];
                
                const segmentInfo = matrix[prevIndex][currentIndex];
                
                // 유효성 검사
                const validDistance = Math.max(100, Math.min(segmentInfo.distance, 1000000));
                const validDuration = Math.max(60, Math.min(segmentInfo.duration, 86400));
                
                cumulativeDistance += validDistance;
                cumulativeTime += validDuration;
                
                // 실제 방문지 정보 (출발지 제외)
                const destination = selectedAddresses[currentIndex - 1];
                
                route.push({
                    order: i,
                    name: destination.name,
                    address: destination.address,
                    contact: destination.contact || '',
                    segmentDistance: segmentInfo.distanceText,
                    segmentTime: segmentInfo.durationText,
                    cumulativeDistance: (cumulativeDistance / 1000).toFixed(1) + 'km',
                    cumulativeTime: Math.round(cumulativeTime / 60) + '분',
                    _rawDistance: validDistance,
                    _rawTime: validDuration
                });
                
                console.log(`${i}. ${destination.name}: ${segmentInfo.distanceText} (누적: ${(cumulativeDistance/1000).toFixed(1)}km)`);
            }
            
            console.log('✅ 최종 경로 정보 생성 완료');
            
            return {
                route: route,
                totalDistance: cumulativeDistance,
                totalTime: cumulativeTime
            };
        }

        // 출발지에서 모든 목적지까지 거리 계산
        function calculateDistancesFromOrigin(origin, destinations) {
            return new Promise((resolve, reject) => {
                const service = new google.maps.DistanceMatrixService();
                
                const destinationAddresses = destinations.map(d => d.address);
                
                service.getDistanceMatrix({
                    origins: [origin],
                    destinations: destinationAddresses,
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC,
                    avoidHighways: false,
                    avoidTolls: false
                }, (response, status) => {
                    console.log('Distance Matrix API 응답:', status);
                    
                    if (status === 'OK') {
                        const results = [];
                        const elements = response.rows[0].elements;
                        
                        for (let i = 0; i < elements.length; i++) {
                            if (elements[i].status === 'OK') {
                                const distance = elements[i].distance.value; // 미터
                                const duration = elements[i].duration.value; // 초
                                
                                // 유효성 검사
                                const validDistance = Math.max(100, Math.min(distance, 1000000)); // 100m ~ 1000km
                                const validDuration = Math.max(60, Math.min(duration, 86400)); // 1분 ~ 24시간
                                
                                if (distance !== validDistance || duration !== validDuration) {
                                    console.warn(`${destinations[i].name}: 거리/시간 보정 (${distance}m → ${validDistance}m, ${duration}s → ${validDuration}s)`);
                                }
                                
                                results.push({
                                    ...destinations[i],
                                    distance: validDistance,
                                    duration: validDuration,
                                    distanceText: elements[i].distance.text,
                                    durationText: elements[i].duration.text
                                });
                            } else {
                                console.warn(`주소 ${destinations[i].address} 계산 실패:`, elements[i].status);
                                // 기본값으로 대체
                                results.push({
                                    ...destinations[i],
                                    distance: 10000, // 10km
                                    duration: 1200, // 20분
                                    distanceText: '약 10km',
                                    durationText: '약 20분'
                                });
                            }
                        }
                        
                        console.log(`거리 계산 완료: ${results.length}개 지점`);
                        resolve(results);
                    } else {
                        console.error('Distance Matrix API 오류:', status);
                        if (status === 'OVER_QUERY_LIMIT') {
                            reject(new Error('일일 사용량을 초과했습니다. 내일 다시 시도해주세요.'));
                        } else if (status === 'REQUEST_DENIED') {
                            reject(new Error('API 키 권한이 없습니다. API 키 설정을 확인해주세요.'));
                        } else {
                            reject(new Error('거리 계산에 실패했습니다: ' + status));
                        }
                    }
                });
            });
        }

        // 거리 기준으로 최적화 (가장 가까운 순서)
        function optimizeByDistance(distances) {
            // 유효하지 않은 거리값 필터링
            const validDistances = distances.filter(d => {
                const isValid = d.distance > 0 && d.distance < 1000000 && // 1000km 이내
                              d.duration > 0 && d.duration < 86400; // 24시간 이내
                if (!isValid) {
                    console.warn(`유효하지 않은 거리 데이터 제외: ${d.name} - ${d.distance}m, ${d.duration}s`);
                }
                return isValid;
            });
            
            if (validDistances.length === 0) {
                console.error('유효한 거리 데이터가 없습니다.');
                return distances; // 원본 반환
            }
            
            const visited = new Set();
            const order = [];
            
            while (visited.size < validDistances.length) {
                let nearest = null;
                let nearestDistance = Infinity;
                
                for (let i = 0; i < validDistances.length; i++) {
                    if (!visited.has(i) && validDistances[i].distance < nearestDistance) {
                        nearestDistance = validDistances[i].distance;
                        nearest = i;
                    }
                }
                
                if (nearest !== null) {
                    visited.add(nearest);
                    order.push(validDistances[nearest]);
                }
            }
            
            console.log(`거리 최적화 완료: ${order.length}개 지점`);
            return order;
        }

        // 실제 경로별 시간 계산 (A→B→C 순서)
        async function calculateRouteTimings(origin, optimizedOrder) {
            let currentPos = origin;
            let cumulativeDistance = 0;
            let cumulativeTime = 0;
            const route = [];
            
            for (let i = 0; i < optimizedOrder.length; i++) {
                const destination = optimizedOrder[i];
                
                let segmentDistance, segmentTime, segmentDistanceText, segmentTimeText;
                
                if (i === 0) {
                    // 첫 번째 목적지는 이미 계산된 값 사용
                    segmentDistance = destination.distance;
                    segmentTime = destination.duration;
                    segmentDistanceText = destination.distanceText;
                    segmentTimeText = destination.durationText;
                } else {
                    // 이전 목적지에서 현재 목적지까지 계산
                    try {
                        const segment = await calculateSegmentTiming(currentPos, destination.address);
                        segmentDistance = segment.distance;
                        segmentTime = segment.duration;
                        segmentDistanceText = segment.distanceText;
                        segmentTimeText = segment.durationText;
                    } catch (error) {
                        console.warn(`구간 ${currentPos} → ${destination.address} 계산 실패:`, error);
                        segmentDistance = 5000; // 기본값 5km (미터)
                        segmentTime = 600; // 기본값 10분 (초)
                        segmentDistanceText = '약 5km';
                        segmentTimeText = '약 10분';
                    }
                }
                
                // 유효성 검사 및 보정
                if (!segmentDistance || segmentDistance <= 0 || segmentDistance > 1000000) {
                    console.warn(`비정상적인 거리값: ${segmentDistance}, 기본값으로 대체`);
                    segmentDistance = 5000; // 5km
                }
                
                if (!segmentTime || segmentTime <= 0 || segmentTime > 86400) {
                    console.warn(`비정상적인 시간값: ${segmentTime}, 기본값으로 대체`);
                    segmentTime = 600; // 10분
                }
                
                cumulativeDistance += segmentDistance;
                cumulativeTime += segmentTime;
                
                route.push({
                    order: i + 1,
                    name: destination.name,
                    address: destination.address,
                    contact: destination.contact || '',
                    segmentDistance: segmentDistanceText,
                    segmentTime: segmentTimeText,
                    cumulativeDistance: (cumulativeDistance / 1000).toFixed(1) + 'km',
                    cumulativeTime: Math.round(cumulativeTime / 60) + '분',
                    // 디버그용 원본 값들
                    _rawDistance: segmentDistance,
                    _rawTime: segmentTime
                });
                
                currentPos = destination.address;
                
                console.log(`구간 ${i + 1}: ${segmentDistanceText} / ${segmentTimeText} (누적: ${(cumulativeDistance/1000).toFixed(1)}km, ${Math.round(cumulativeTime/60)}분)`);
            }
            
            // 최종 검증
            const finalDistance = Math.max(0, Math.min(cumulativeDistance, 10000000)); // 최대 10,000km
            const finalTime = Math.max(0, Math.min(cumulativeTime, 864000)); // 최대 240시간
            
            console.log(`최종 계산 결과: ${(finalDistance/1000).toFixed(1)}km, ${Math.round(finalTime/60)}분`);
            
            return {
                route: route,
                totalDistance: finalDistance,
                totalTime: finalTime
            };
        }

        // 두 지점 간 거리/시간 계산
        function calculateSegmentTiming(origin, destination) {
            return new Promise((resolve, reject) => {
                const service = new google.maps.DistanceMatrixService();
                
                service.getDistanceMatrix({
                    origins: [origin],
                    destinations: [destination],
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC
                }, (response, status) => {
                    if (status === 'OK') {
                        const element = response.rows[0].elements[0];
                        if (element.status === 'OK') {
                            resolve({
                                distance: element.distance.value,
                                duration: element.duration.value,
                                distanceText: element.distance.text,
                                durationText: element.duration.text
                            });
                        } else {
                            reject(new Error('구간 계산 실패: ' + element.status));
                        }
                    } else {
                        reject(new Error('서비스 오류: ' + status));
                    }
                });
            });
        }

        // 결과 표시
        function displayResults() {
            const { route, totalDistance, totalTime } = optimizedRoute;
            
            // 안전한 값 표시를 위한 검증
            const safeDistance = Math.max(0, Math.min(totalDistance || 0, 10000000)); // 최대 10,000km
            const safeTime = Math.max(0, Math.min(totalTime || 0, 864000)); // 최대 240시간
            
            // 요약 정보 업데이트
            const distanceKm = (safeDistance / 1000).toFixed(1);
            const timeMin = Math.round(safeTime / 60);
            const timeHour = Math.floor(timeMin / 60);
            const remainMin = timeMin % 60;
            
            document.getElementById('totalDistance').textContent = distanceKm + 'km';
            
            // 시간 표시 개선 (1시간 이상일 때)
            if (timeHour > 0) {
                document.getElementById('totalTime').textContent = `${timeHour}시간 ${remainMin}분`;
            } else {
                document.getElementById('totalTime').textContent = timeMin + '분';
            }
            
            document.getElementById('totalPlaces').textContent = route.length + '곳';
            
            // 콘솔 로그로 디버깅
            console.log(`=== 최종 결과 ===`);
            console.log(`총 거리: ${distanceKm}km (${safeDistance}m)`);
            console.log(`총 시간: ${timeMin}분 (${safeTime}초)`);
            console.log(`방문지: ${route.length}곳`);
            console.log(`================`);
            
            updateRouteDisplay();
            document.getElementById('results').style.display = 'block';
            
            // 지도에 경로 표시
            displayRouteOnMap();
            
            console.log('결과 표시 완료');
        }

        // 경로 목록 업데이트
        function updateRouteDisplay() {
            const { route } = optimizedRoute;
            const routeList = document.getElementById('routeList');
            routeList.innerHTML = '';
            
            // 진행률 계산
            const completedCount = route.filter(item => visitedAddresses.has(getAddressKey(item))).length;
            const progressPercent = (completedCount / route.length) * 100;
            
            // 진행률 표시
            const progressDiv = document.createElement('div');
            progressDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; flex: 1;">방문 진행률</h4>
                    <button class="reset-btn" onclick="resetAllVisited()">전체 초기화</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div class="progress-text">${completedCount}/${route.length} 완료 (${progressPercent.toFixed(1)}%)</div>
            `;
            routeList.appendChild(progressDiv);
            
            // 출발지
            const startDiv = document.createElement('div');
            startDiv.className = 'route-item start';
            startDiv.innerHTML = `
                <div class="route-number start">🏠</div>
                <div class="route-info">
                    <div class="route-name">출발지</div>
                    <div class="route-address">${currentLocation}</div>
                    <div class="route-timing">여기서 시작</div>
                </div>
            `;
            routeList.appendChild(startDiv);
            
            // 방문지들
            route.forEach(item => {
                const isCompleted = visitedAddresses.has(getAddressKey(item));
                const div = document.createElement('div');
                div.className = `route-item ${isCompleted ? 'completed' : ''}`;
                div.innerHTML = `
                    <div class="route-number ${isCompleted ? 'completed' : ''}">${item.order}</div>
                    <div class="route-info">
                        <div class="route-name">${item.name}</div>
                        ${item.contact ? `<div class="route-contact">📞 ${item.contact}</div>` : ''}
                        <div class="route-address">${item.address}</div>
                        <div class="route-timing">
                            ${item.segmentDistance} | ${item.segmentTime} 
                            (누적: ${item.cumulativeDistance} | ${item.cumulativeTime})
                        </div>
                    </div>
                    <input type="checkbox" class="visit-checkbox" 
                           ${isCompleted ? 'checked' : ''} 
                           onchange="toggleVisitStatus({name: '${item.name.replace(/'/g, "\\'")}', address: '${item.address.replace(/'/g, "\\'")}', contact: '${(item.contact || '').replace(/'/g, "\\'")}'}"
                           title="방문 완료 체크">
                `;
                routeList.appendChild(div);
            });
        }

        // 지도에 경로 표시
        function displayRouteOnMap() {
            console.log('지도에 경로 표시 시작');
            
            if (!optimizedRoute || !optimizedRoute.route) {
                console.error('표시할 경로 데이터가 없습니다.');
                return;
            }
            
            // 지도 컨테이너 표시
            document.getElementById('mapContainer').querySelector('.map-loading').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            
            // 지도 초기화 (한 번만)
            if (!map) {
                console.log('지도 초기화 중...');
                const container = document.getElementById('map');
                const options = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780),
                    level: 7
                };
                map = new kakao.maps.Map(container, options);
                console.log('지도 초기화 완료');
            }
            
            // 기존 마커와 경로 삭제
            clearMapElements();
            
            // 좌표 변환 및 마커 표시
            convertAddressesToCoordinates();
        }

        // 주소를 좌표로 변환하고 마커 표시
        function convertAddressesToCoordinates() {
            const addresses = [
                { address: currentLocation, type: 'start', title: '출발지' },
                ...optimizedRoute.route.map(item => ({
                    address: item.address,
                    type: 'destination',
                    title: `${item.order}. ${item.name}`,
                    data: item
                }))
            ];
            
            let completedCount = 0;
            const coordinates = [];
            
            addresses.forEach((item, index) => {
                geocoder.addressSearch(item.address, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        coordinates[index] = {
                            position: coords,
                            type: item.type,
                            title: item.title,
                            data: item.data
                        };
                        
                        completedCount++;
                        
                        if (completedCount === addresses.length) {
                            createMarkersAndRoute(coordinates);
                        }
                    } else {
                        console.error(`주소 변환 실패: ${item.address}`);
                        completedCount++;
                    }
                });
            });
        }

        // 마커와 경로선 생성
        function createMarkersAndRoute(coordinates) {
            coordinates.forEach((coord, index) => {
                // 마커 생성
                const marker = new kakao.maps.Marker({
                    position: coord.position,
                    map: map
                });
                
                // 인포윈도우 생성
                const infoContent = createInfoWindowContent(coord);
                const infowindow = new kakao.maps.InfoWindow({
                    content: infoContent
                });
                
                // 마커 클릭 이벤트
                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, marker);
                });
                
                markers.push(marker);
                
                // 경로선 그리기 (마지막 지점 제외)
                if (index < coordinates.length - 1) {
                    const linePath = [
                        coord.position,
                        coordinates[index + 1].position
                    ];
                    
                    const polyline = new kakao.maps.Polyline({
                        path: linePath,
                        strokeWeight: 3,
                        strokeColor: '#e74c3c',
                        strokeOpacity: 0.7,
                        strokeStyle: 'solid'
                    });
                    
                    polyline.setMap(map);
                    polylines.push(polyline);
                }
            });
            
            // 지도 범위 조정
            const bounds = new kakao.maps.LatLngBounds();
            coordinates.forEach(coord => bounds.extend(coord.position));
            map.setBounds(bounds);
        }

        // 정보창 내용 생성
        function createInfoWindowContent(coord, isCompleted) {
            let content = `<div class="info-window-content">`;
            
            // 제목
            content += `<h4 class="info-window-title">${coord.title}</h4>`;
            
            // 연락처 (있는 경우)
            if (coord.contact) {
                content += `<p class="info-window-contact">📞 ${coord.contact}</p>`;
            }
            
            // 주소
            content += `<p class="info-window-address">📍 ${coord.address}</p>`;
            
            // 방문 상태
            if (coord.type !== 'start') {
                const statusClass = isCompleted ? 'completed' : 'pending';
                const statusText = isCompleted ? '✅ 방문 완료' : '🎯 방문 예정';
                content += `<p class="info-window-status ${statusClass}">${statusText}</p>`;
            }
            
            content += `</div>`;
            return content;
        }

        // 지도 표시 업데이트
        function updateMapDisplay() {
            if (map && optimizedRoute) {
                displayRouteOnMap();
            }
        }

        // 경로 화살표 생성
        function createRouteArrows(coordinates) {
            for (let i = 0; i < coordinates.length - 1; i++) {
                const start = coordinates[i].position;
                const end = coordinates[i + 1].position;
                
                // 직선 경로
                const routePath = new google.maps.Polyline({
                    path: [start, end],
                    geodesic: true,
                    strokeColor: '#e74c3c',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    map: map,
                    icons: [{
                        icon: {
                            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                            scale: 4,
                            fillColor: '#e74c3c',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 1
                        },
                        offset: '100%'
                    }]
                });
                
                polylines.push(routePath);
                
                // 중간 지점에 순서 표시
                const midLat = (start.lat() + end.lat()) / 2;
                const midLng = (start.lng() + end.lng()) / 2;
                
                const orderMarker = new google.maps.Marker({
                    position: { lat: midLat, lng: midLng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#e74c3c',
                        fillOpacity: 0.9,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    label: {
                        text: String(i + 1),
                        color: '#ffffff',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    zIndex: 998
                });
                
                markers.push(orderMarker);
            }
        }

        // 지도 요소 정리
        function clearMapElements() {
            // 기존 마커들 제거
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // 기존 경로들 제거
            polylines.forEach(polyline => polyline.setMap(null));
            polylines = [];
        }

        // 결과 다운로드
        function downloadResults() {
            if (!optimizedRoute || !optimizedRoute.route) {
                showError('먼저 경로를 계산해주세요.');
                return;
            }

            const { route, totalDistance, totalTime } = optimizedRoute;

            let csv = '\uFEFF'; // UTF-8 BOM
            csv += '순서,이름,연락처,주소,이동거리,이동시간,누적거리,누적시간,방문상태\n';
            csv += `출발지,현재위치,,"${currentLocation}",0km,0분,0km,0분,시작점\n`;
            
            route.forEach(item => {
                const visitStatus = visitedAddresses.has(getAddressKey(item)) ? '완료' : '예정';
                csv += `${item.order},"${item.name}","${item.contact || ''}","${item.address}",${item.segmentDistance},${item.segmentTime},${item.cumulativeDistance},${item.cumulativeTime},${visitStatus}\n`;
            });

            csv += `총계,-,-,-,${(totalDistance / 1000).toFixed(1)}km,${Math.round(totalTime / 60)}분,${(totalDistance / 1000).toFixed(1)}km,${Math.round(totalTime / 60)}분,-\n`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            const selectedRegion = document.getElementById('regionSelect').value || '지역';
            const today = new Date().toISOString().split('T')[0];
            link.download = `방문순서_${selectedRegion}_${today}.csv`;
            link.click();

            console.log('CSV 다운로드 완료');
        }

        // 인쇄
        function printResults() {
            // 인쇄용 스타일 추가
            const printStyle = `
                <style media="print">
                    body * { visibility: hidden; }
                    #results, #results * { visibility: visible; }
                    #results { position: absolute; left: 0; top: 0; width: 100%; }
                    .download-section { display: none !important; }
                    .visit-checkbox { display: none !important; }
                    .reset-btn { display: none !important; }
                    .route-item { page-break-inside: avoid; }
                    .summary { page-break-inside: avoid; }
                </style>
            `;
            
            document.head.insertAdjacentHTML('beforeend', printStyle);
            window.print();
            
            // 인쇄 후 스타일 제거
            setTimeout(() => {
                const styleElement = document.querySelector('style[media="print"]');
                if (styleElement) styleElement.remove();
            }, 1000);
        }

        // UI 함수들
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('results').style.display = 'none';
            console.error('오류:', message);
        }

        // Google Maps API 로드 확인
        function initMap() {
            console.log('✅ Google Maps API 로드 완료');
            console.log('사용 가능한 라이브러리:', Object.keys(google.maps));
            
            // Geometry 라이브러리 확인
            if (google.maps.geometry) {
                console.log('✅ Geometry 라이브러리 로드됨');
            } else {
                console.warn('⚠️ Geometry 라이브러리 없음');
            }
            
            // 지도는 결과 표시될 때 초기화됨
        }

        // API 로드 실패 처리
        window.gm_authFailure = function() {
            console.error('Google Maps API 인증 실패');
            showError('Google Maps API 인증 실패. API 키를 확인해주세요.');
        };

        // API 로드 에러 핸들링
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Google Maps')) {
                console.error('Google Maps 로드 에러:', e);
                showError('Google Maps 로드 중 오류가 발생했습니다.');
            }
        });

        // 현재 위치 자동 설정
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const locPosition = new kakao.maps.LatLng(lat, lng);
                        
                        // 기존 현재 위치 마커 제거
                        if (currentLocationMarker) {
                            currentLocationMarker.setMap(null);
                        }
                        
                        // 새 마커 생성
                        currentLocationMarker = new kakao.maps.Marker({
                            map: map,
                            position: locPosition
                        });
                        
                        // 지도 중심 이동
                        map.setCenter(locPosition);
                        map.setLevel(4);
                        
                        // 상태 메시지 표시
                        showStatus('locationStatus', '현재 위치를 찾았습니다.', 'success');
                    },
                    function(error) {
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '위치 정보 접근이 거부되었습니다.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '위치 정보를 사용할 수 없습니다.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '위치 정보 요청이 시간 초과되었습니다.';
                                break;
                            default:
                                errorMessage = '알 수 없는 오류가 발생했습니다.';
                        }
                        showStatus('locationStatus', errorMessage, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );
            } else {
                showStatus('locationStatus', '이 브라우저에서는 위치 정보를 사용할 수 없습니다.', 'error');
            }
        }
        
        // 좌표를 주소로 변환
        function reverseGeocode(lat, lng) {
            return new Promise((resolve, reject) => {
                if (!geocoder) {
                    reject(new Error('Kakao Maps API가 초기화되지 않았습니다.'));
                    return;
                }

                geocoder.coord2Address(lng, lat, (result, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        if (result && result.length > 0) {
                            const address = result[0].address.address_name;
                            resolve(address);
                        } else {
                            reject(new Error('주소를 찾을 수 없습니다.'));
                        }
                    } else {
                        reject(new Error('주소 변환에 실패했습니다.'));
                    }
                });
            });
        }
        
        // 위치 오류 처리
        function handleGeolocationError(error) {
            let errorMessage = '';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '위치 접근 권한이 거부되었습니다. 브라우저 설정에서 위치 권한을 허용해주세요.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '위치 정보를 사용할 수 없습니다.';
                    break;
                case error.TIMEOUT:
                    errorMessage = '위치 요청 시간이 초과되었습니다.';
                    break;
                default:
                    errorMessage = '알 수 없는 오류가 발생했습니다.';
                    break;
            }
            showLocationError(errorMessage);
        }

        // 위치 오류 표시
        function showLocationError(message) {
            const btn = document.getElementById('getCurrentLocationBtn');
            const status = document.getElementById('locationStatus');
            
            btn.disabled = false;
            btn.textContent = '📍 현재위치';
            
            status.textContent = `❌ ${message}`;
            status.style.color = '#e74c3c';
            status.style.display = 'block';
            
            // 5초 후 상태 메시지 숨기기
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // 네트워크 상태 확인
        function checkNetworkAndAPI() {
            if (!navigator.onLine) {
                showError('인터넷 연결을 확인해주세요.');
                return false;
            }
            
            if (typeof kakao === 'undefined' || !kakao.maps) {
                showError('Kakao Maps API가 로드되지 않았습니다. 페이지를 새로고침해주세요.');
                return false;
            }
            
            return true;
        }

        // 로컬스토리지 데이터 내보내기/가져오기 함수들 (백업용)
        function exportVisitData() {
            try {
                const data = {
                    visitedAddresses: [...visitedAddresses],
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `방문기록_백업_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                console.log('방문 기록 백업 완료');
            } catch (error) {
                console.error('백업 실패:', error);
                showError('백업 중 오류가 발생했습니다.');
            }
        }

        function importVisitData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.visitedAddresses && Array.isArray(data.visitedAddresses)) {
                        visitedAddresses = new Set(data.visitedAddresses);
                        saveVisitedAddresses();
                        
                        // UI 업데이트
                        if (optimizedRoute) {
                            updateRouteDisplay();
                            updateMapDisplay();
                        }
                        
                        // 지역 선택 드롭다운도 업데이트
                        if (Object.keys(regionGroups).length > 0) {
                            groupByRegion();
                        }
                        
                        alert(`방문 기록을 복원했습니다. (${visitedAddresses.size}개 기록)`);
                        console.log('방문 기록 복원 완료:', visitedAddresses.size);
                    } else {
                        throw new Error('유효하지 않은 백업 파일입니다.');
                    }
                } catch (error) {
                    console.error('복원 실패:', error);
                    showError('백업 파일을 읽을 수 없습니다.');
                }
            };
            reader.readAsText(file);
        }

        // 페이지 언로드 시 데이터 자동 저장
        window.addEventListener('beforeunload', function() {
            saveVisitedAddresses();
        });

        // 주기적으로 데이터 저장 (5분마다)
        setInterval(function() {
            if (visitedAddresses.size > 0) {
                saveVisitedAddresses();
                console.log('자동 저장 완료');
            }
        }, 5 * 60 * 1000); // 5분

        // 디버그 함수들 (개발용)
        function debugInfo() {
            console.log('=== 디버그 정보 ===');
            console.log('전체 주소 수:', allAddresses.length);
            console.log('지역 그룹:', Object.keys(regionGroups));
            console.log('방문 완료 수:', visitedAddresses.size);
            console.log('선택된 주소 수:', selectedAddresses.length);
            console.log('계산된 경로:', optimizedRoute);
            console.log('==================');
        }

        // 개발자 도구에서 사용할 수 있는 유틸리티 함수들
        window.debug = {
            info: debugInfo,
            exportData: exportVisitData,
            clearAll: () => {
                if (confirm('모든 데이터를 삭제하시겠습니까?')) {
                    localStorage.clear();
                    location.reload();
                }
            },
            showVisited: () => console.log([...visitedAddresses])
        };

        // 방문 기록 저장
        function saveVisitedAddresses() {
            try {
                localStorage.setItem('visitedAddresses', JSON.stringify([...visitedAddresses]));
                console.log('방문 기록 저장 완료:', visitedAddresses.size);
            } catch (error) {
                console.error('방문 기록 저장 실패:', error);
            }
        }

        // 방문 기록 불러오기
        function loadVisitedAddresses() {
            try {
                const saved = localStorage.getItem('visitedAddresses');
                if (saved) {
                    visitedAddresses = new Set(JSON.parse(saved));
                    console.log('방문 기록 로드 완료:', visitedAddresses.size);
                }
            } catch (error) {
                console.error('방문 기록 로드 실패:', error);
                visitedAddresses = new Set();
            }
        }

        // 파일 처리 이벤트 설정
        function setupFileUploadEvents(uploadArea, fileInput) {
            // 드래그 앤 드롭 이벤트
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            };
            
            uploadArea.ondragleave = () => {
                uploadArea.classList.remove('dragover');
            };
            
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            };
            
            // 파일 선택 이벤트
            fileInput.onchange = (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            };
        }

        // 지역 선택 이벤트 처리
        function handleRegionChange(event) {
            const selectedRegion = event.target.value;
            if (selectedRegion) {
                updateRegionInfo(selectedRegion);
            } else {
                document.getElementById('regionInfo').style.display = 'none';
                document.getElementById('calculateBtn').disabled = true;
            }
        }

        // API 로드 실패 처리
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Kakao Maps')) {
                console.error('Kakao Maps 로드 에러:', e);
                showError('지도 서비스 로드 중 오류가 발생했습니다.');
            }
        });
    </script>
</body>
</html>